# -----------------------------------------------------------------
# Docker Compose for litellm (Portainer friendly)
# -----------------------------------------------------------------
# The original `db` service is commented out because you use Supabase.
# Keep it here for reference / quick re‑enable during local testing.
# -----------------------------------------------------------------

services:
  # Litellm gateway (proxy)
  skypiea-gateway:
    container_name: skypiea-gateway
    build:
      context: .
      args:
        target: runtime
    image: ghcr.io/itsreiji/skypiea-gateway:latest
    # command:
    #   - "--config=/app/proxy_server_config.yaml"
    ports:
      - "4000:4000"
    environment:
      - LITELLM_MASTER_KEY=${LITELLM_MASTER_KEY}
      - LITELLM_SALT_KEY=${LITELLM_SALT_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - STORE_MODEL_IN_DB=${STORE_MODEL_IN_DB}
      - STORE_PROMPTS_IN_SPEND_LOGS=${STORE_PROMPTS_IN_SPEND_LOGS}
      - UI_USERNAME=${UI_USERNAME}
      - UI_PASSWORD=${UI_PASSWORD}
      - DOCS_TITLE=${DOCS_TITLE}
      - DOCS_DESCRIPTION=${DOCS_DESCRIPTION}
    restart: always
    healthcheck:  # Defines the health check configuration for the container
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 http://localhost:4000/health/liveliness || exit 1" ]  # Command to execute for health check
      interval: 30s  # Perform health check every 30 seconds
      timeout: 10s   # Health check command times out after 10 seconds
      retries: 3     # Retry up to 3 times if health check fails
      start_period: 40s  # Wait 40 seconds after container start before beginning health checks

  # Prometheus monitoring (optional)
  prometheus:
    image: prom/prometheus
    volumes:
      - prometheus_data:/prometheus
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
    restart: always

# -----------------------------------------------------------------
# Disabled internal Postgres (use Supabase instead)
# -----------------------------------------------------------------
#  db:
#    image: postgres:18
#    restart: always
#    container_name: litellm_db
#    environment:
#      POSTGRES_DB: litellm
#      POSTGRES_USER: llmproxy
#      POSTGRES_PASSWORD: dbpassword9090
#    ports:
#      - "5432:5432"
#    volumes:
#      - postgres_data:/var/lib/postgresql/data # Persists Postgres data across container restarts
#    healthcheck:
#      test: ["CMD-SHELL", "pg_isready -d litellm -U llmproxy"]
#      interval: 1s
#      timeout: 5s
#      retries: 10

volumes:
  # Volume kept for compatibility – not used when you run Supabase externally
  postgres_data:
    name: litellm_postgres_data
  prometheus_data:
    driver: local
